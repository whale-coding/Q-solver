name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    permissions:
      contents: write
    
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          check-latest: true
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache Go Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ~/go/bin/wails.exe
          key: ${{ runner.os }}-go-tools-wails-v1

      - name: Install Tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          Write-Host "Installing Wails..."
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build
        run: |
          Write-Host "üî® Starting Wails Build..."
          wails build -ldflags "-s -w" -tags prod

      - name: Prepare Artifact
        run: |
          $ExePath = "build\bin\Q-Solver.exe"
          if (Test-Path $ExePath) {
              Write-Host "‚úÖ Build successful: $ExePath"
          } else {
              Write-Error "‚ùå Executable not found! Build failed?"
              exit 1
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Q-Solver-Windows-amd64.exe
          path: build/bin/Q-Solver.exe
          if-no-files-found: error

  build-macos-arm64:
    name: Build macOS (Apple Silicon)
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          check-latest: true
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache Go Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ~/go/bin/wails
          key: ${{ runner.os }}-arm64-go-tools-wails-v1

      - name: Install Tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          echo "Installing Wails..."
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build
        run: |
          echo "üî® Starting Wails Build for macOS (arm64)..."
          wails build -ldflags "-s -w" -tags prod

      - name: Prepare Artifact
        run: |
          APP_PATH="build/bin/Q-Solver.app"
          if [ -d "$APP_PATH" ]; then
              echo "‚úÖ Build successful: $APP_PATH"
              # ÈáçÂëΩÂêç app ‰ª•Âå∫ÂàÜÊû∂ÊûÑ
              mv "$APP_PATH" "build/bin/Q-Solver-macOS-arm64.app"
          else
              echo "‚ùå App bundle not found! Build failed?"
              exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Q-Solver-macOS-arm64.app
          path: build/bin/Q-Solver-macOS-arm64.app
          if-no-files-found: error

  build-macos-amd64:
    name: Build macOS (Intel)
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          check-latest: true
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache Go Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ~/go/bin/wails
          key: ${{ runner.os }}-macos15-arm-cross-amd64-wails-v1

      - name: Install Tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          echo "Installing Wails..."
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build
        run: |
          echo "üî® Starting Wails Build for macOS (Intel/amd64) on ARM runner..."
          wails build -ldflags "-s -w" -tags prod -platform darwin/amd64

      - name: Verify & Rename Artifact
        run: |
          APP_PATH="build/bin/Q-Solver.app"
          SUB_PATH="build/bin/darwin/amd64/Q-Solver.app"

          TARGET_NAME="build/bin/Q-Solver-macOS-amd64.app"

          if [ -d "$SUB_PATH" ]; then
              echo "‚úÖ Found app in subdir: $SUB_PATH"
              mv "$SUB_PATH" "$TARGET_NAME"
          elif [ -d "$APP_PATH" ]; then
              echo "‚úÖ Found app in root bin: $APP_PATH"
              ARCH=$(lipo -archs "$APP_PATH/Contents/MacOS/Q-Solver")
              echo "üîç Verified Architecture: $ARCH"
              if [[ "$ARCH" != *"x86_64"* ]]; then
                  echo "‚ùå Error: Expected x86_64 (amd64) but got $ARCH"
                  exit 1
              fi
              mv "$APP_PATH" "$TARGET_NAME"
          else
              echo "‚ùå App bundle not found! Build failed?"
              echo "Listing build/bin contents:"
              ls -R build/bin/
              exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Q-Solver-macOS-amd64.app
          path: build/bin/Q-Solver-macOS-amd64.app
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build-windows, build-macos-arm64, build-macos-amd64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: Q-Solver-Windows-amd64.exe
          path: artifacts/

      - name: Download macOS arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: Q-Solver-macOS-arm64.app
          path: artifacts/Q-Solver-macOS-arm64.app/

      - name: Download macOS amd64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: Q-Solver-macOS-amd64.app
          path: artifacts/Q-Solver-macOS-amd64.app/

      - name: Prepare Release Files
        run: |
          cd artifacts
          # Windows exe Áõ¥Êé•ÈáçÂëΩÂêç
          mv Q-Solver.exe Q-Solver-Windows-amd64.exe
          # macOS app ÈúÄË¶ÅÂéãÁº©ÔºàÂõ†‰∏∫ÊòØÁõÆÂΩïÔºâ
          zip -r Q-Solver-macOS-arm64.zip Q-Solver-macOS-arm64.app
          zip -r Q-Solver-macOS-amd64.zip Q-Solver-macOS-amd64.app
          ls -la

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/Q-Solver-Windows-amd64.exe
            artifacts/Q-Solver-macOS-arm64.zip
            artifacts/Q-Solver-macOS-amd64.zip
          generate_release_notes: true